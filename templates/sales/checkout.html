{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Checkout</h2>
    <form id="payment-form" action="{% url 'checkout' %}" method="post">
        {% csrf_token %}
        <div class="form-group">
            <label for="address">Address</label>
            <input type="text" name="address" id="address" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="city">City</label>
            <input type="text" name="city" id="city" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="postal_code">Postal Code</label>
            <input type="text" name="postal_code" id="postal_code" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="country">Country</label>
            <input type="text" name="country" id="country" class="form-control" required>
        </div>

        <!-- Stripe kart bilgisi alanı -->
        <div class="form-group">
            <label for="card-element">Credit or debit card</label>
            <div id="card-element" class="form-control"></div>
            <div id="card-errors" role="alert"></div>
        </div>

        <button type="submit" class="btn btn-success mt-3">Pay ${{ total_price }}</button>
    </form>
</div>

<!-- Stripe JS Kütüphanesi -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe("{{ stripe_publishable_key }}");  // Publishable key ile Stripe'ı başlat
    var elements = stripe.elements();
    var card = elements.create("card");
    card.mount("#card-element");

    card.on("change", function (event) {
        var displayError = document.getElementById("card-errors");
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = "";
        }
    });

    // Form gönderildiğinde Stripe ile ödeme işlemini gerçekleştir
    var form = document.getElementById("payment-form");
    form.addEventListener("submit", function(event) {
        event.preventDefault();
        stripe.confirmCardPayment("{{ client_secret }}", {
            payment_method: {
                card: card,
                billing_details: {
                    name: "{{ request.user.username }}",
                    address: {
                        line1: document.getElementById("address").value,
                        city: document.getElementById("city").value,
                        postal_code: document.getElementById("postal_code").value,
                        country: document.getElementById("country").value
                    }
                }
            }
        }).then(function(result) {
            if (result.error) {
                // Ödeme hatası durumunda göster
                document.getElementById("card-errors").textContent = result.error.message;
            } else {
                if (result.paymentIntent.status === "succeeded") {
                    form.submit();  // Ödeme başarılı olduğunda formu gönder
                }
            }
        });
    });
</script>
{% endblock %}
